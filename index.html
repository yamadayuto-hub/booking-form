<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é£¯è¡Œãæ—¥</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#fafafa;
    --card:#ffffff;
    --muted:#8f8f8f;
    --accent:#111;
    --radius:12px;
    --max-width:820px;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    background:var(--bg);
    font-family:"Noto Sans JP",-apple-system,system-ui;
    display:flex;
    justify-content:center;
    padding:28px 16px;
  }
  .wrap{width:100%;max-width:var(--max-width);}

  /* Header */
  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:18px;
  }
  .title{
    font-size:26px;
    font-weight:600;
    text-align:center;
    flex:1;
  }
  .edit-name{
    font-size:14px;
    text-decoration:underline;
    cursor:pointer;
    color:#000;
    white-space:nowrap;
  }

  /* Card */
  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:20px;
    box-shadow:0 8px 28px rgba(0,0,0,0.05);
    margin-bottom:20px;
  }
  .card-title{
    font-size:17px;
    font-weight:700;
    margin-bottom:12px;
    padding-left:6px;
  }

  .field{margin-top:10px;}
  select,input{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #e5e5e5;
    font-size:15px;
  }
  button{
    width:100%;
    padding:11px;
    border-radius:10px;
    border:0;
    cursor:pointer;
  }
  .primary{
    background:#111;
    color:#fff;
    font-weight:600;
    margin-top:14px;
  }

  /* List */
  .branch{
    padding:14px 16px;
    border:1px solid #eee;
    border-radius:12px;
    margin-top:14px;
  }
  .branch-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .branch-title{
    font-size:17px;
    font-weight:700;
  }
  .edit-btn{
    cursor:pointer;
    font-size:18px;
    margin-left:8px;
  }
  .branch-meta{
    color:var(--muted);
    margin-top:6px;
  }
  .members{
    margin-top:8px;
    font-size:15px;
  }
  .join-area{
    margin-top:10px;
    display:flex;
    gap:6px;
  }
  .join-btn, .cancel-btn{
    flex:1;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    background:#fff;
    cursor:pointer;
  }
</style>
</head>

<body>
<div class="wrap">

  <!-- header -->
  <div class="topbar">
    <div class="title">é£¯è¡Œãæ—¥</div>
    <div class="edit-name" onclick="location.href='name.html'">è¡¨ç¤ºåä¿®æ­£</div>
  </div>

  <!-- æ–°ã—ãè¿½åŠ  -->
  <div class="card" id="newCard">
    <div class="card-title" style="margin-left:8px;">æ–°ã—ãè¿½åŠ </div>

    <div class="field">
      <select id="dateSelect"></select>
    </div>

    <div class="field">
      <select id="timeSelect">
        <option value="æ˜¼">æ˜¼</option>
        <option value="å¤œ">å¤œ</option>
      </select>
    </div>

    <div class="field">
      <select id="placeSelect">
        <option value="æ©‹æœ¬">æ©‹æœ¬</option>
        <option value="å¤§é˜ª">å¤§é˜ª</option>
        <option value="äº¬éƒ½">äº¬éƒ½</option>
        <option value="ã©ã“ã§ã‚‚">ã©ã“ã§ã‚‚</option>
      </select>
    </div>

    <button class="primary" id="createBtn">æ–°è¦ä½œæˆ</button>
  </div>

  <!-- ä»–ã®ç´„æŸ -->
  <div class="card">
    <div class="card-title" style="margin-left:8px;">ä»–ã®ç´„æŸ</div>
    <div id="branchList"></div>
  </div>

</div>

<script>
/* --- Supabase Init --- */
const supabase = supabase.createClient(
  "https://agbfcpaxsrgebxjtkvdh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYmZjcGF4c3JnZWJ4anRrdmRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODY4ODAsImV4cCI6MjA4MDc2Mjg4MH0.8Mp6MotCT5z2rTd0iIWhXz3aV696ijBEkYk9tVIYpgw"
);

/* ---- Utility ---- */
function format(d,time,place){
  return `${d} / ${time} / ${place}`;
}

/* ---- æ—¥ä»˜ç”Ÿæˆï¼ˆå›ºå®šï¼‰ ---- */
const validDates = [
  "2025/12/29",
  "2025/12/30",
  "2026/01/02",
  "2026/01/03",
  "2026/01/04"
];
const dateSelect = document.getElementById("dateSelect");
validDates.forEach(d=>{
  const op=document.createElement("option");
  op.value=d;
  op.textContent=d;
  dateSelect.appendChild(op);
});

/* ---- load branches ---- */
async function loadBranches(){
  const { data } = await supabase.from("branches").select("*").order("date",{ascending:true});
  renderBranches(data || []);
}

/* ---- render ---- */
function renderBranches(list){
  const el=document.getElementById("branchList");
  el.innerHTML="";

  list.forEach(b=>{
    const div=document.createElement("div");
    div.className="branch";

    div.innerHTML=`
      <div class="branch-header">
        <div class="branch-title">
          ${b.title} <span class="edit-btn" data-id="${b.id}">ğŸ“</span>
        </div>
      </div>

      <div class="branch-meta">${format(b.date,b.time,b.place)}</div>

      <div class="members">${b.members.join("ã€")}</div>

      <div class="join-area">
        <button class="join-btn" data-join="${b.id}">å‚åŠ </button>
        <button class="cancel-btn" data-cancel="${b.id}">å–ã‚Šæ¶ˆã—</button>
      </div>
    `;
    el.appendChild(div);
  });
}

/* ---- æ–°è¦ä½œæˆ ---- */
document.getElementById("createBtn").onclick = async ()=>{
  const name = localStorage.getItem("username");
  if(!name){ location.href="name.html"; return; }

  const date = document.getElementById("dateSelect").value;
  const time = document.getElementById("timeSelect").value;
  const place = document.getElementById("placeSelect").value;

  await supabase.from("branches").insert({
    date,time,place,
    title:"ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š",
    members:[name]
  });

  location.reload();
};

/* ---- click events ---- */
document.body.addEventListener("click", async (e)=>{
  // title edit
  if(e.target.dataset.id){
    const id=e.target.dataset.id;
    const newTitle = prompt("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›", "");
    if(newTitle){
      await supabase.from("branches").update({title:newTitle}).eq("id",id);
      location.reload();
    }
  }

  // join
  if(e.target.dataset.join){
    const id=e.target.dataset.join;
    const name = localStorage.getItem("username");
    if(!name){ location.href="name.html"; return; }
    const { data } = await supabase.from("branches").select("*").eq("id",id).single();
    if(!data.members.includes(name)){
      const members=[...data.members,name];
      await supabase.from("branches").update({members}).eq("id",id);
    }
    location.reload();
  }

  // cancel
  if(e.target.dataset.cancel){
    const id=e.target.dataset.cancel;
    const name = localStorage.getItem("username");
    const { data } = await supabase.from("branches").select("*").eq("id",id).single();
    const members=data.members.filter(x=>x!==name);

    if(members.length===0){
      await supabase.from("branches").delete().eq("id",id);
    } else {
      await supabase.from("branches").update({members}).eq("id",id);
    }
    location.reload();
  }
});

/* ---- Realtime â†’ ä»–ã®ç«¯æœ«ã®å¤‰æ›´å³æ™‚åæ˜  ---- */
supabase
  .channel("public:branches")
  .on("postgres_changes",
      { event:"*", schema:"public", table:"branches" },
      payload => {
        location.reload();
      })
  .subscribe();

/* Start */
loadBranches();
</script>

</body>
</html>
