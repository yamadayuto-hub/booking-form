<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é£¯è¡Œãæ—¥</title>

<!-- supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
  :root{
    --bg:#fbfbfb;
    --card:#ffffff;
    --muted:#8f8f8f;
    --accent:#111;
    --radius:12px;
    --gap:16px;
    --max-width:780px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    font-family: "Noto Sans JP", -apple-system, system-ui, "Helvetica Neue", Arial;
    color:#111;
    display:flex;
    justify-content:center;
    padding:22px 12px 80px;
  }
  .wrap{width:100%;max-width:var(--max-width);}

  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .page-title{
    font-size:28px;
    font-weight:600;
    margin:0;
    text-align:left;
  }
  /* è¡¨ç¤ºåä¿®æ­£: é»’ä¸‹ç·š */
  .edit-name-btn{
    background:transparent;border:0;color:#000;text-decoration:underline;font-size:14px;cursor:pointer;
  }

  /* headings */
  .section-title{font-size:18px;font-weight:700;margin:28px 0 12px;padding-left:2px}

  /* form card */
  .card{
    background:var(--card);
    border-radius:12px;
    padding:16px;
    box-shadow:0 6px 24px rgba(20,24,28,0.06);
    margin-bottom:var(--gap);
  }
  label.small{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  select, button{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid #eaeaea;font-size:15px;background:#fff;
  }
  button.primary{background:var(--accent);color:#fff;border:0;padding:10px;border-radius:10px;font-weight:700;cursor:pointer}

  /* branch item */
  .branch{
    background:#fff;border-radius:12px;padding:12px 14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04);
  }
  .branch-date{font-size:14px;color:#444;margin-bottom:6px}
  .branch-title{display:flex;align-items:center;gap:8px;font-size:16px;font-weight:700;margin-bottom:6px}
  .branch-title .pencil{cursor:pointer;font-size:16px}
  .branch-members{font-size:14px;color:#333;margin-bottom:8px;word-break:break-word}
  .branch-actions{display:flex;gap:10px}
  .branch-actions button{flex:1;padding:9px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:14px}

  /* responsive tighten */
  @media (max-width:560px){
    .page-title{font-size:22px}
    .branch{padding:12px}
    .branch-actions button{padding:10px;font-size:13px}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="page-title">é£¯è¡Œãæ—¥</div>
    <button class="edit-name-btn" id="editNameBtn">è¡¨ç¤ºåä¿®æ­£</button>
  </div>

  <div class="section-title">æ–°ã—ãè¿½åŠ </div>
  <div class="card" id="newCard">
    <label class="small">æ—¥ä»˜</label>
    <select id="newDate"></select>

    <label class="small" style="margin-top:10px">æ™‚é–“å¸¯</label>
    <select id="newTime">
      <option value="æ˜¼">æ˜¼</option>
      <option value="å¤œ">å¤œ</option>
    </select>

    <label class="small" style="margin-top:10px">å ´æ‰€</label>
    <select id="newPlace">
      <option value="æ©‹æœ¬">æ©‹æœ¬</option>
      <option value="å¤§é˜ª">å¤§é˜ª</option>
      <option value="äº¬éƒ½">äº¬éƒ½</option>
      <option value="ã©ã“ã§ã‚‚">ã©ã“ã§ã‚‚</option>
    </select>

    <button class="primary" id="createAndJoinBtn" style="margin-top:12px">æ–°è¦ä½œæˆã—ã¦å‚åŠ </button>
  </div>

  <div class="section-title">ä»–ã®ç´„æŸ</div>
  <div id="reserveList" class="card" style="padding:12px;">
    <div id="loading" style="color:var(--muted)">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<!-- name modal (simple) -->
<div id="nameModal" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:999;visibility:hidden;opacity:0;transition:opacity .18s;">
  <div style="background:#fff;padding:18px;border-radius:12px;width:92%;max-width:420px;">
    <div style="font-weight:700;margin-bottom:6px">è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <div style="color:#777;margin-bottom:12px">ä»Šå¾Œè‡ªå‹•ã§ä½¿ã‚ã‚Œã¾ã™ï¼ˆå¾Œã§ä¿®æ­£å¯ã€20æ–‡å­—ã¾ã§ï¼‰</div>
    <input id="nameInput" type="text" maxlength="20" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:10px" />
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="saveNameBtn" class="primary">ä¿å­˜</button>
      <button id="cancelNameBtn" style="padding:10px;border-radius:10px;border:1px solid #ddd;background:#fff">ã‚ã¨ã§</button>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG â€” æ›¸ãæ›ãˆã¦ä½¿ã† ==================
   - ä»¥ä¸‹2ã¤ã¯Supabaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå¾Œã«ç½®ãæ›ãˆã¦ãã ã•ã„
   - ç½®ãæ›ãˆãŒãªã‘ã‚Œã° localStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‹•ãã¾ã™ï¼ˆåŒæœŸã•ã‚Œãªã„ï¼‰
============================================================= */
const SUPABASE_URL = "https://agbfcpaxsrgebxjtkvdh.supabase.co";       // <-- ã“ã“ã‚’ç½®ãæ›ãˆã‚‹
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYmZjcGF4c3JnZWJ4anRrdmRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODY4ODAsImV4cCI6MjA4MDc2Mjg4MH0.8Mp6MotCT5z2rTd0iIWhXz3aV696ijBEkYk9tVIYpgw";                          // <-- ã“ã“ã‚’ç½®ãæ›ãˆã‚‹
/* =========================================================== */

let useSupabase = SUPABASE_URL && SUPABASE_ANON_KEY && !SUPABASE_URL.includes("YOUR-");
if(useSupabase){
  // initialize supabase
  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} else {
  console.warn("Supabaseã‚­ãƒ¼æœªè¨­å®šï¼šlocalStorageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‹•ä½œã—ã¾ã™ï¼ˆåŒæœŸã•ã‚Œã¾ã›ã‚“ï¼‰");
}

/* ---------- utility ---------- */
function uid(){ return 'b_' + Math.random().toString(36).slice(2,9); }
function toShortDateFromISO(iso){ // '2026/01/03' or '2026-01-03' => '26/01/03'
  if(!iso) return '';
  const s = iso.indexOf('-')>=0 ? iso : iso;
  let parts = iso.includes('-') ? iso.split('-') : iso.split('/');
  if(parts.length===3){
    const yy = parts[0].slice(-2);
    return `${yy}/${parts[1]}/${parts[2]}`;
  }
  return iso;
}
function normalizeDateInput(val){ // val is yyyy-mm-dd -> 'YY/MM/DD'
  if(!val) return '';
  const p = val.split('-');
  if(p.length!==3) return val;
  const yy = p[0].slice(2);
  return `${yy}/${p[1]}/${p[2]}`;
}

/* ---------- DOM ---------- */
const newDateSel = document.getElementById('newDate');
const newTimeSel = document.getElementById('newTime');
const newPlaceSel = document.getElementById('newPlace');
const createBtn = document.getElementById('createAndJoinBtn');
const reserveListWrap = document.getElementById('reserveList');
const loadingEl = document.getElementById('loading');

const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('nameInput');
const saveNameBtn = document.getElementById('saveNameBtn');
const cancelNameBtn = document.getElementById('cancelNameBtn');
const editNameBtn = document.getElementById('editNameBtn');

let myName = localStorage.getItem('meeting_app_username') || '';
if(myName) nameInput.value = myName;

/* ---------- date options (25/12/29 - 26/01/04) as select to avoid mobile issues ---------- */
function populateDates(){
  const start = new Date(2025,11,29); // Dec 29 2025
  const end = new Date(2026,0,4);     // Jan 4 2026
  let d = new Date(start);
  newDateSel.innerHTML = '';
  while(d <= end){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const iso = `${yyyy}-${mm}-${dd}`; // for input coherence
    const display = `${String(yyyy).slice(2)}/${mm}/${dd}`;
    const o = document.createElement('option');
    o.value = iso;
    o.textContent = display;
    newDateSel.appendChild(o);
    d.setDate(d.getDate()+1);
  }
}
populateDates();

/* ---------- Supabase / local data helpers ---------- */
async function fetchBranchesFromSupabase(){
  loadingEl.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
  try{
    const { data, error } = await supabase
      .from('branches')
      .select('*')
      .order('date', { ascending: true })
      .order('time', { ascending: true })
      .limit(1000);
    if(error) throw error;
    return data || [];
  }catch(e){
    console.error(e);
    return [];
  }finally{
    loadingEl.textContent = "";
  }
}

function readLocalBranches(){
  try{
    return JSON.parse(localStorage.getItem('meeting_app_branches') || '[]');
  }catch(e){ return []; }
}
function writeLocalBranches(list){
  localStorage.setItem('meeting_app_branches', JSON.stringify(list));
}

/* ---------- render ---------- */
function renderBranches(branches){
  // sort by date (YY/MM/DD or YYYY-MM-DD) then time (æ˜¼ before å¤œ)
  branches.sort((a,b)=>{
    // normalize date to YYYY/MM/DD for comparison if needed
    const da = (a.date.indexOf('-')>=0 ? a.date.replace(/-/g,'/') : a.date);
    const db = (b.date.indexOf('-')>=0 ? b.date.replace(/-/g,'/') : b.date);
    if(da !== db) return da < db ? -1 : 1;
    if(a.time === b.time) return 0;
    return a.time === 'æ˜¼' ? -1 : 1;
  });

  // clear and build
  reserveListWrap.innerHTML = '';
  if(branches.length === 0){
    reserveListWrap.innerHTML = '<div style="color:var(--muted)">ç¾åœ¨ã€ä»–ã®ç´„æŸã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  branches.forEach(b => {
    const branchEl = document.createElement('div');
    branchEl.className = 'branch';

    // date display: ensure YY/MM/DD
    let dateDisplay = b.date.includes('-') ? normalizeDateInput(b.date) : b.date;
    if(b.date.indexOf('/')>=0 && b.date.length===10 && b.date.startsWith('20')) dateDisplay = toShortDateFromISO(b.date);

    const dateHtml = `<div class="branch-date">${dateDisplay} / ${b.time} / ${b.place}</div>`;
    const titleHtml = `<div class="branch-title"><span>${b.title ? escapeHtml(b.title) : 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰'}</span><span class="pencil" title="ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†">ğŸ“</span></div>`;
    const membersHtml = `<div class="branch-members">${Array.isArray(b.members) ? b.members.join('ã€') : ''}</div>`;

    branchEl.innerHTML = dateHtml + titleHtml + membersHtml;

    // actions
    const actions = document.createElement('div');
    actions.className = 'branch-actions';
    const btnJoin = document.createElement('button');
    btnJoin.textContent = 'å‚åŠ ';
    const btnLeave = document.createElement('button');
    btnLeave.textContent = 'å–ã‚Šæ¶ˆã—';

    btnJoin.onclick = ()=> handleJoin(b);
    btnLeave.onclick = ()=> handleLeave(b);

    actions.appendChild(btnJoin);
    actions.appendChild(btnLeave);
    branchEl.appendChild(actions);

    // pencil
    branchEl.querySelector('.pencil').onclick = (e)=>{
      e.stopPropagation();
      const t = prompt('ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç·¨é›†ï¼ˆèª°ã§ã‚‚ç·¨é›†å¯èƒ½ï¼‰', b.title || '');
      if(t === null) return;
      const newTitle = String(t).trim();
      if(useSupabase){
        updateBranchTitleSupabase(b.id, newTitle);
      } else {
        // local fallback
        b.title = newTitle;
        const local = readLocalBranches().map(x => x.id===b.id? b : x);
        writeLocalBranches(local);
        renderBranches(local);
      }
    };

    reserveListWrap.appendChild(branchEl);
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- join / leave ---------- */
async function handleJoin(branch){
  const name = getMyNameOrAsk();
  if(!name) return;
  // conflict check: cannot be in another branch same date+time
  const conflict = await checkConflict(branch.date, branch.time, name);
  if(conflict){ alert('åŒã˜æ—¥ãƒ»æ™‚é–“å¸¯ã«ã¯æ—¢ã«å‚åŠ æ¸ˆã¿ã§ã™ã€‚å…ˆã«å–ã‚Šæ¶ˆã—ã¦ãã ã•ã„ã€‚'); return; }

  if(useSupabase){
    // append name to members array in supabase
    try{
      const { data, error } = await supabase.rpc('append_member', { branch_id: branch.id, member_name: name });
      if(error) throw error;
      // server triggers realtime; no need to reload immediately
    }catch(e){
      console.error(e);
      alert('å‚åŠ å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸ');
    }
  } else {
    // local fallback
    const local = readLocalBranches();
    const idx = local.findIndex(x=>x.id===branch.id);
    if(idx>=0 && !local[idx].members.includes(name)){
      local[idx].members.push(name);
      writeLocalBranches(local);
      renderBranches(local);
    }
  }
}

async function handleLeave(branch){
  const name = localStorage.getItem('meeting_app_username') || '';
  if(!name){ alert('è¡¨ç¤ºåãŒæœªè¨­å®šã§ã™'); showNameModal(); return; }
  if(useSupabase){
    try{
      // remove name from members array
      const { data, error } = await supabase.rpc('remove_member', { branch_id: branch.id, member_name: name });
      if(error) throw error;
    }catch(e){
      console.error(e);
      alert('å–ã‚Šæ¶ˆã—ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸ');
    }
  } else {
    const local = readLocalBranches();
    const idx = local.findIndex(x=>x.id===branch.id);
    if(idx>=0){
      local[idx].members = local[idx].members.filter(m=>m!==name);
      if(local[idx].members.length===0){
        local.splice(idx,1);
      }
      writeLocalBranches(local);
      renderBranches(local);
    }
  }
}

/* ---------- conflict check ---------- */
async function checkConflict(date, time, name){
  // date may be ISO or YY/MM/DD; normalize to storage form used
  if(useSupabase){
    try{
      // query branches with same date and time where members contains name
      const { data, error } = await supabase
        .from('branches')
        .select('id')
        .eq('date', date)
        .eq('time', time)
        .contains('members', [name]);
      if(error) throw error;
      return (data && data.length>0);
    }catch(e){
      console.error(e);
      return false; // be permissive on error
    }
  } else {
    const local = readLocalBranches();
    return local.some(b=>b.date===date && b.time===time && b.members.includes(name));
  }
}

/* ---------- create branch ---------- */
createBtn.onclick = async ()=>{
  const name = getMyNameOrAsk();
  if(!name) return;

  const dateIso = newDateSel.value; // yyyy-mm-dd
  const date = normalizeDateInput(dateIso); // format YY/MM/DD
  const time = newTimeSel.value;
  const place = newPlaceSel.value;

  // double-check date within allowed range (extra safety)
  const allowedDates = Array.from(newDateSel.options).map(o=>o.value);
  if(!allowedDates.includes(dateIso)){
    alert('æœ‰åŠ¹ãªæ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„');
    return;
  }

  if(useSupabase){
    try{
      const { data, error } = await supabase
        .from('branches')
        .insert([{ date: date, time: time, place: place, title: '', members: [name] }]);
      if(error) throw error;
      // success: realtime will notify others
    }catch(e){
      console.error(e);
      alert('ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  } else {
    // local fallback
    const local = readLocalBranches();
    const b = { id: uid(), date: date, time: time, place: place, title: '', members: [name] };
    local.push(b);
    writeLocalBranches(local);
    renderBranches(local);
  }
};

/* ---------- name modal helpers ---------- */
function showNameModal(){ nameModal.style.visibility='visible'; nameModal.style.opacity='1'; }
function hideNameModal(){ nameModal.style.opacity='0'; setTimeout(()=>nameModal.style.visibility='hidden',180); }
saveNameBtn.onclick = ()=> {
  const v = (nameInput.value || '').trim().slice(0,20);
  if(!v){ alert('è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  localStorage.setItem('meeting_app_username', v);
  myName = v;
  hideNameModal();
};
cancelNameBtn.onclick = ()=> hideNameModal();
editNameBtn.onclick = ()=> {
  const cur = localStorage.getItem('meeting_app_username') || '';
  const nv = prompt('è¡¨ç¤ºåã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§20æ–‡å­—ï¼‰', cur);
  if(nv === null) return;
  const t = nv.trim().slice(0,20);
  if(!t){ alert('ç©ºã«ã¯ã§ãã¾ã›ã‚“'); return; }
  localStorage.setItem('meeting_app_username', t);
  myName = t;
};

/* ---------- get name or show modal ---------- */
function getMyNameOrAsk(){
  const name = localStorage.getItem('meeting_app_username') || '';
  if(!name){ showNameModal(); return null; }
  return name;
}

/* ---------- realtime subscription & bootstrap ---------- */
let localCache = readLocalBranches();
if(!useSupabase){
  // local fallback: render localCache
  if(localCache.length===0){
    // try apply presets if none
    const presets = [
      { id: uid(), date:'25/12/29', time:'å¤œ', place:'æ©‹æœ¬', title:'å¤§å­¦å¿˜å¹´ä¼š', members:['Hirao','ãƒˆã‚­ãƒ„','è—¤æœ¨'] },
      { id: uid(), date:'26/01/03', time:'å¤œ', place:'äº¬éƒ½', title:'ä¸­å­¦åŒçª“ä¼š', members:['Ogawa','ã‹ãšã','MOE','Ami','yuina'] }
    ];
    localCache = presets;
    writeLocalBranches(localCache);
  }
  renderBranches(localCache);
} else {
  // create RPC functions for safe array append/remove if not present (docs below)
  (async ()=>{
    // fetch and render initial data
    const data = await fetchBranchesFromSupabase();
    if(!data || data.length===0){
      // insert presets if table empty
      try{
        const { data: res, error } = await supabase
          .from('branches')
          .insert([
            { date:'25/12/29', time:'å¤œ', place:'æ©‹æœ¬', title:'å¤§å­¦å¿˜å¹´ä¼š', members:['Hirao','ãƒˆã‚­ãƒ„','è—¤æœ¨'] },
            { date:'26/01/03', time:'å¤œ', place:'äº¬éƒ½', title:'ä¸­å­¦åŒçª“ä¼š', members:['Ogawa','ã‹ãšã','MOE','Ami','yuina'] }
          ]);
        // ignore errors
      }catch(e){ console.error(e); }
    }
    // now load fresh
    const fresh = await fetchBranchesFromSupabase();
    renderBranches(fresh);
  })();

  // subscribe to realtime changes on branches table
  supabase.channel('public:branches')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'branches' }, payload => {
      // payload: INSERT / UPDATE / DELETE
      // simple approach: reload all branches (cheap for small dataset)
      (async ()=>{
        const fresh = await fetchBranchesFromSupabase();
        renderBranches(fresh);
      })();
    })
    .subscribe()
    .catch(e => console.warn('subscribe failed', e));
}

/* ---------- helper: update branch title (supabase) ---------- */
async function updateBranchTitleSupabase(id, newTitle){
  try{
    const { data, error } = await supabase.from('branches').update({ title: newTitle }).eq('id', id);
    if(error) throw error;
  }catch(e){ console.error(e); alert('ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}

/* ---------- NOTE about array append/remove stored procedures (optional) ----------
 To safely append/remove a member from text[] in Postgres via Supabase RPC, you can
 create Postgres functions in SQL Editor (only once). If your project allows
 writing directly (anon key), you can also do an update with server-side array
 operators. For simplicity above we used RPC 'append_member' and 'remove_member'
 references in earlier code â€” but to avoid needing RPC you can perform a full-row
 update from the client: read, modify array, write back. For low concurrency this is fine.

 If you want the SQL to create append/remove RPC helpers, run:

 -- append_member
 create or replace function public.append_member(branch_id uuid, member_name text)
 returns void language plpgsql as $$
 begin
   update public.branches set members = array_append(members, member_name) where id = branch_id and not (members @> array[member_name]);
 end; $$;

 -- remove_member
 create or replace function public.remove_member(branch_id uuid, member_name text)
 returns void language plpgsql as $$
 begin
   update public.branches set members = array_remove(members, member_name) where id = branch_id;
 end; $$;

 In this HTML we used simple update patterns; you can optionally add the above functions for safer array ops.
---------------------------------------------------------------------------------- */

</script>
</body>
</html>
