<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é£¯è¡Œãæ—¥</title>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        margin: 0;
        padding: 0;
        background: #f7f7f7;
        color: #222;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 20px;
        border-bottom: 1px solid #ddd;
        background: white;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .top-title {
        font-size: 22px;
        font-weight: bold;
        margin: 0 auto;
        transform: translateX(20px); /* å³ã®ãƒªãƒ³ã‚¯ã®åˆ†ã ã‘èª¿æ•´ã—ã¦ä¸­å¤® */
    }
    .edit-name-link {
        font-size: 14px;
        color: black;
        text-decoration: underline;
        cursor: pointer;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— */
    h2 {
        margin: 30px 0 10px 20px;
        font-size: 18px;
        font-weight: bold;
    }

    /* ã‚«ãƒ¼ãƒ‰UI */
    .card {
        background: white;
        border-radius: 14px;
        padding: 14px 18px;
        margin: 14px 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 6px 0;
        flex-wrap: wrap;
    }

    .date-line {
        font-size: 15px;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .title-line {
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .members {
        font-size: 14px;
        color: #444;
        margin-top: 6px;
    }

    .btn {
        padding: 6px 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-join {
        background: #222;
        color: white;
    }

    .btn-cancel {
        background: #ddd;
        color: #333;
    }

    .title-edit {
        cursor: pointer;
    }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .popup-bg {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.4);
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .popup-box {
        background: white;
        padding: 26px;
        border-radius: 12px;
        width: 80%;
        max-width: 300px;
        text-align: center;
        font-size: 16px;
    }
    .popup-btn {
        margin-top: 20px;
        padding: 8px 16px;
        background: #222;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    /* è¡¨ç¤ºåå…¥åŠ›ãƒšãƒ¼ã‚¸ */
    .name-page, .edit-name-page {
        padding: 30px;
        display: none;
    }
    .name-page.active, .edit-name-page.active, .main-page.active {
        display: block;
    }
    input, select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 10px;
        font-size: 16px;
    }
    .submit-btn {
        margin-top: 20px;
        width: 100%;
        background: #222;
        color: white;
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</head>

<body>

<!-- è¡¨ç¤ºåå…¥åŠ›ãƒšãƒ¼ã‚¸ -->
<div id="namePage" class="name-page">
    <h2>è¡¨ç¤ºåã‚’å…¥åŠ›</h2>
    <input id="nameInput" placeholder="è¡¨ç¤ºå">
    <button class="submit-btn" onclick="saveName()">æ±ºå®š</button>
</div>

<!-- è¡¨ç¤ºåä¿®æ­£ãƒšãƒ¼ã‚¸ -->
<div id="editNamePage" class="edit-name-page">
    <h2>è¡¨ç¤ºåã‚’ä¿®æ­£</h2>
    <input id="editNameInput">
    <button class="submit-btn" onclick="updateName()">æ›´æ–°</button>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ -->
<div id="mainPage" class="main-page">

    <div class="top-bar">
        <div class="top-title">é£¯è¡Œãæ—¥</div>
        <div class="edit-name-link" onclick="openEditName()">è¡¨ç¤ºåä¿®æ­£</div>
    </div>

    <h2 style="margin-left:30px;">æ–°ã—ãè¿½åŠ </h2>
    <div class="card">
        <div class="row">
            <select id="newDate"></select>
        </div>
        <div class="row">
            <select id="newTime">
                <option value="æ˜¼">æ˜¼</option>
                <option value="å¤œ">å¤œ</option>
            </select>
        </div>
        <div class="row">
            <select id="newPlace">
                <option value="æ©‹æœ¬">æ©‹æœ¬</option>
                <option value="å¤§é˜ª">å¤§é˜ª</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option>
                <option value="ã©ã“ã§ã‚‚">ã©ã“ã§ã‚‚</option>
            </select>
        </div>
        <button class="submit-btn" onclick="createBranch()">æ–°è¦ä½œæˆã—ã¦å‚åŠ </button>
    </div>

    <h2 style="margin-left:30px;">ä»–ã®ç´„æŸ</h2>
    <div id="branchList"></div>

</div>


<!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="popup" class="popup-bg">
    <div class="popup-box">
        <div id="popupMessage"></div>
        <button class="popup-btn" onclick="closePopup()">OK</button>
    </div>
</div>




<!-- Supabase ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ---------------------------------------------------------
   Supabase åˆæœŸåŒ–ï¼ˆã‚ãªãŸå°‚ç”¨ï¼‰
--------------------------------------------------------- */
const SUPABASE_URL = "https://agbfcpaxsrgebxjtkvdh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYmZjcGF4c3JnZWJ4anRrdmRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODY4ODAsImV4cCI6MjA4MDc2Mjg4MH0.8Mp6MotCT5z2rTd0iIWhXz3aV696ijBEkYk9tVIYpgw";

const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------------------------------------------------
   è¡¨ç¤ºåãƒšãƒ¼ã‚¸ â†’ ãƒ¡ã‚¤ãƒ³
--------------------------------------------------------- */
function show(pageId) {
    document.querySelectorAll(".name-page, .edit-name-page, .main-page")
        .forEach(el => el.classList.remove("active"));
    document.getElementById(pageId).classList.add("active");
}

/* ---------------------------------------------------------
   è¡¨ç¤ºåã®ç®¡ç†ï¼ˆlocalStorageï¼‰
--------------------------------------------------------- */
let username = localStorage.getItem("username");

window.onload = () => {
    // æ—¥ä»˜é¸æŠè‚¢ã‚’ä½œã‚‹
    setupDates();

    if (!username) {
        show("namePage");
    } else {
        show("mainPage");
        loadBranches();
    }

    // Realtime
    supabase
        .channel("realtime:branches")
        .on("postgres_changes", { event: "*", schema: "public", table: "branches" }, () => {
            loadBranches();
        })
        .subscribe();
}

function saveName() {
    const v = document.getElementById("nameInput").value.trim();
    if (!v) return;
    localStorage.setItem("username", v);
    username = v;
    show("mainPage");
    loadBranches();
}

function openEditName() {
    document.getElementById("editNameInput").value = username;
    show("editNamePage");
}

function updateName() {
    const v = document.getElementById("editNameInput").value.trim();
    if (!v) return;
    localStorage.setItem("username", v);
    username = v;
    popup("è¡¨ç¤ºåã‚’æ›´æ–°ã—ã¾ã—ãŸ");
    show("mainPage");
}


/* ---------------------------------------------------------
   æ—¥ä»˜åˆ¶å¾¡
--------------------------------------------------------- */
function setupDates() {
    const select = document.getElementById("newDate");
    const start = new Date(2025, 11, 29); // 25/12/29
    const end   = new Date(2026, 0, 4);   // 26/01/04

    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const y = d.getFullYear().toString().slice(-2);
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = `${y}/${m}/${day}`;
        opt.textContent = `${y}/${m}/${day}`;
        select.appendChild(opt);
    }
}


/* ---------------------------------------------------------
   ãƒ–ãƒ©ãƒ³ãƒèª­è¾¼
--------------------------------------------------------- */
async function loadBranches() {
    const { data, error } = await supabase
        .from("branches")
        .select("*")
        .order("date")
        .order("time");

    const list = document.getElementById("branchList");
    list.innerHTML = "";

    if (!data) return;

    data.forEach(br => {
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
            <div class="date-line">${br.date} / ${br.time} / ${br.place}</div>
            <div class="title-line">
                ${br.title}
                <span class="title-edit" onclick="editTitle('${br.id}', '${br.title}')">ğŸ“</span>
            </div>
            <div class="members">${br.members.join("ã€")}</div>
            <div class="row" style="margin-top:10px;">
                ${br.members.includes(username)
                    ? `<button class="btn btn-cancel" onclick="leave('${br.id}')">å–ã‚Šæ¶ˆã—</button>`
                    : `<button class="btn btn-join" onclick="join('${br.id}')">å‚åŠ </button>`
                }
            </div>
        `;
        list.appendChild(div);
    });
}


/* ---------------------------------------------------------
   æ–°è¦ä½œæˆ
--------------------------------------------------------- */
async function createBranch() {
    const date = document.getElementById("newDate").value;
    const time = document.getElementById("newTime").value;
    const place = document.getElementById("newPlace").value;

    const { error } = await supabase.from("branches").insert({
        date, time, place,
        title: "",
        members: [username]
    });

    popup("è¿½åŠ ã—ã¾ã—ãŸ");
}


/* ---------------------------------------------------------
   å‚åŠ 
--------------------------------------------------------- */
async function join(id) {
    const { data } = await supabase
        .from("branches")
        .select("members")
        .eq("id", id)
        .single();

    const arr = data.members;
    if (!arr.includes(username)) arr.push(username);

    await supabase.from("branches").update({ members: arr }).eq("id", id);
    popup("å‚åŠ ã—ã¾ã—ãŸ");
}

/* ---------------------------------------------------------
   å–ã‚Šæ¶ˆã—
--------------------------------------------------------- */
async function leave(id) {
    const { data } = await supabase
        .from("branches")
        .select("*")
        .eq("id", id)
        .single();

    const arr = data.members.filter(m => m !== username);

    if (arr.length === 0) {
        await supabase.from("branches").delete().eq("id", id);
    } else {
        await supabase.from("branches").update({ members: arr }).eq("id", id);
    }

    popup("å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
}

/* ---------------------------------------------------------
   ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†
--------------------------------------------------------- */
async function editTitle(id, oldTitle) {
    const v = prompt("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›", oldTitle);
    if (v === null) return;

    await supabase.from("branches").update({ title: v }).eq("id", id);
    popup("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
}

/* ---------------------------------------------------------
   ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
--------------------------------------------------------- */
function popup(msg) {
    document.getElementById("popupMessage").textContent = msg;
    document.getElementById("popup").style.display = "flex";

    setTimeout(() => location.reload(), 500);
}

function closePopup() {
    document.getElementById("popup").style.display = "none";
    location.reload();
}
</script>

</body>
</html>
