<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é£¯è¡Œãæ—¥</title>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
  :root{
    --bg:#fbfbfb;--card:#fff;--muted:#8f8f8f;--accent:#111;--radius:12px;--max-width:780px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans JP", -apple-system, system-ui, "Helvetica Neue", Arial;color:#111;display:flex;justify-content:center;padding:18px 12px 80px}
  .wrap{width:100%;max-width:var(--max-width)}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:28px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .edit-link{color:#000;text-decoration:underline;font-size:14px;cursor:pointer;margin-left:12px;white-space:nowrap}
  .section-title{font-size:18px;font-weight:700;margin:28px 0 12px;padding-left:2px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.04);margin-bottom:18px}
  label.small{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
  select, button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #eaeaea;font-size:15px;background:#fff}
  button.primary{background:var(--accent);color:#fff;border:0;padding:10px;border-radius:10px;font-weight:700;cursor:pointer}
  /* branch */
  #reserveList{padding:10px}
  .branch{background:#fff;border-radius:12px;padding:10px 12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
  .branch-date{font-size:14px;color:#444;margin-bottom:6px}
  .branch-title{display:flex;align-items:center;gap:8px;font-size:16px;font-weight:700;margin-bottom:6px}
  .branch-members{font-size:14px;color:#333;margin-bottom:8px;word-break:break-word}
  .branch-actions{display:flex;gap:10px}
  .branch-actions button{flex:1;padding:9px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:14px}
  .notif{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none}
  @media (max-width:560px){
    .title{font-size:22px}
    .branch-actions button{padding:10px;font-size:13px}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="top">
    <div class="title">é£¯è¡Œãæ—¥</div>
    <div style="margin-left:12px"><a class="edit-link" id="editNameBtn">è¡¨ç¤ºåä¿®æ­£</a></div>
  </div>

  <div class="section-title">æ–°ã—ãè¿½åŠ </div>
  <div class="card" id="newCard">
    <label class="small">æ—¥ä»˜</label>
    <select id="newDate"></select>

    <label class="small" style="margin-top:10px">æ™‚é–“å¸¯</label>
    <select id="newTime"><option value="æ˜¼">æ˜¼</option><option value="å¤œ">å¤œ</option></select>

    <label class="small" style="margin-top:10px">å ´æ‰€</label>
    <select id="newPlace">
      <option value="æ©‹æœ¬">æ©‹æœ¬</option>
      <option value="å¤§é˜ª">å¤§é˜ª</option>
      <option value="äº¬éƒ½">äº¬éƒ½</option>
      <option value="ã©ã“ã§ã‚‚">ã©ã“ã§ã‚‚</option>
    </select>

    <button class="primary" id="createBtn" style="margin-top:12px">æ–°è¦ä½œæˆ</button>
  </div>

  <div class="section-title">ä»–ã®ç´„æŸ</div>
  <div class="card" id="reserveList">
    <div id="loading" style="color:var(--muted)">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<div class="notif" id="notif"></div>

<script>
/* ================== Supabase è¨­å®šï¼ˆã“ã“ã‚’ã‚ãªãŸã®å€¤ã«ç½®ãæ›ãˆã‚‹ï¼‰ ================== */
const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";    // <- ç½®æ›
const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";                  // <- ç½®æ›
/* ============================================================================== */

let useSupabase = SUPABASE_URL && SUPABASE_ANON_KEY && !SUPABASE_URL.includes("YOUR");
if(useSupabase){
  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} else {
  console.warn("Supabase æœªè¨­å®š: localStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‹•ä½œã—ã¾ã™ï¼ˆåŒæœŸã•ã‚Œã¾ã›ã‚“ï¼‰");
}

/* ---------- utilities ---------- */
function uid(){ return 'b_' + Math.random().toString(36).slice(2,9); }
function notify(text){ const n = document.getElementById('notif'); n.textContent = text; n.style.transition='none'; n.style.opacity='1'; setTimeout(()=>{ n.style.transition='opacity .5s'; n.style.opacity='0' }, 1800); }

/* ---------- DOM refs ---------- */
const newDateSel = document.getElementById('newDate');
const newTimeSel = document.getElementById('newTime');
const newPlaceSel = document.getElementById('newPlace');
const createBtn = document.getElementById('createBtn');
const reserveListWrap = document.getElementById('reserveList');
const loadingEl = document.getElementById('loading');
const editNameBtn = document.getElementById('editNameBtn');

/* ---------- name handling ---------- */
function getName(){ return localStorage.getItem('meeting_app_username') || ''; }
function ensureName(){ const n = getName(); if(!n){ alert('è¡¨ç¤ºåãŒæœªè¨­å®šã§ã™ã€‚è¡¨ç¤ºåå…¥åŠ›ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™'); location.href='name.html'; return false } return true; }
editNameBtn.addEventListener('click', ()=> location.href='name.html');

/* ---------- populate date options (select) ---------- */
function populateDates(){
  const start = new Date(2025,11,29);
  const end = new Date(2026,0,4);
  let d = new Date(start);
  newDateSel.innerHTML = '';
  while(d <= end){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const iso = `${yyyy}-${mm}-${dd}`; // value
    const display = `${String(yyyy).slice(2)}/${mm}/${dd}`;
    const o = document.createElement('option'); o.value=iso; o.textContent=display;
    newDateSel.appendChild(o);
    d.setDate(d.getDate()+1);
  }
}
populateDates();

/* ---------- local fallback helpers ---------- */
function readLocal(){ try{ return JSON.parse(localStorage.getItem('meeting_app_branches')||'[]'); }catch(e){return[]} }
function writeLocal(list){ localStorage.setItem('meeting_app_branches', JSON.stringify(list)); }

/* ---------- supabase helpers ---------- */
async function fetchBranchesSupabase(){
  loadingEl.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
  try{
    const { data, error } = await supabase.from('branches').select('*').order('date', {ascending:true}).order('time',{ascending:true});
    if(error) throw error;
    return data || [];
  }catch(e){ console.error(e); return []; } finally { loadingEl.textContent=''; }
}

/* ---------- render ---------- */
function normalizeDateIsoToYYMMDD(iso){
  // iso: yyyy-mm-dd
  if(!iso) return '';
  const p = iso.split('-'); if(p.length!==3) return iso;
  return p[0].slice(2)+'/'+p[1]+'/'+p[2];
}
function dateStorageFormatFromRecord(rec){
  // rec.date may be '25/12/29' or '2026-01-03' etc.
  if(!rec) return '';
  if(typeof rec.date === 'string'){
    if(rec.date.indexOf('-')>=0) return normalizeDateIsoToYYMMDD(rec.date);
    return rec.date;
  }
  return rec.date;
}

function renderBranches(list){
  // list: array
  if(!Array.isArray(list)) list = [];
  // sort by date/time
  list.sort((a,b)=>{
    const da = (a.date.indexOf('-')>=0 ? a.date.replace(/-/g,'/') : a.date);
    const db = (b.date.indexOf('-')>=0 ? b.date.replace(/-/g,'/') : b.date);
    if(da !== db) return da < db ? -1 : 1;
    if(a.time === b.time) return 0;
    return a.time === 'æ˜¼' ? -1 : 1;
  });

  reserveListWrap.innerHTML = '';
  if(list.length===0){
    reserveListWrap.innerHTML = '<div style="color:var(--muted)">ç¾åœ¨ã€ä»–ã®ç´„æŸã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  list.forEach(b=>{
    const el = document.createElement('div'); el.className='branch';
    const dateDisplay = (b.date.indexOf('-')>=0) ? normalizeDateIsoToYYMMDD(b.date) : b.date;
    el.innerHTML = `
      <div class="branch-date">${dateDisplay} / ${b.time} / ${b.place}</div>
      <div class="branch-title"><span>${b.title?escapeHtml(b.title):'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰'}</span><span class="pencil" title="ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†">ğŸ“</span></div>
      <div class="branch-members">${Array.isArray(b.members)? b.members.join('ã€') : ''}</div>
    `;

    const actions = document.createElement('div'); actions.className='branch-actions';
    const btnJoin = document.createElement('button'); btnJoin.textContent='å‚åŠ ';
    const btnLeave = document.createElement('button'); btnLeave.textContent='å–ã‚Šæ¶ˆã—';
    actions.appendChild(btnJoin); actions.appendChild(btnLeave);
    el.appendChild(actions);

    // attach events
    el.querySelector('.pencil').addEventListener('click', async (e)=>{
      e.stopPropagation();
      const newTitle = prompt('ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç·¨é›†ï¼ˆèª°ã§ã‚‚ç·¨é›†å¯èƒ½ï¼‰', b.title || '');
      if(newTitle === null) return;
      const trimmed = String(newTitle).trim();
      if(useSupabase){
        try{ await supabase.from('branches').update({ title: trimmed }).eq('id', b.id); notify('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'); }
        catch(e){ console.error(e); alert('ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      } else {
        const local = readLocal(); const idx = local.findIndex(x=>x.id===b.id);
        if(idx>=0){ local[idx].title = trimmed; writeLocal(local); renderBranches(local); notify('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'); }
      }
    });

    btnJoin.addEventListener('click', ()=> handleJoinClick(b));
    btnLeave.addEventListener('click', ()=> handleLeaveClick(b));

    reserveListWrap.appendChild(el);
  });
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- join/leave logic (client optimistic + server) ---------- */
async function handleJoinClick(branch){
  const name = getName(); if(!name) return ensureName();
  // conflict check: same date/time already joined
  const sameDate = (x) => {
    const dx = x.date.indexOf('-')>=0 ? normalizeDateIsoToYYMMDD(x.date) : x.date;
    const bx = branch.date.indexOf('-')>=0 ? normalizeDateIsoToYYMMDD(branch.date) : branch.date;
    return dx === bx && x.time === branch.time && x.members && x.members.includes(name);
  };

  // check locally first if useSupabase - we'll query server
  if(useSupabase){
    try{
      const { data: conflicts, error } = await supabase.from('branches').select('id').eq('date', branch.date).eq('time', branch.time).contains('members',[name]);
      if(error) throw error;
      if(conflicts && conflicts.length>0){ alert('åŒã˜æ—¥ãƒ»æ™‚é–“å¸¯ã«ã¯æ—¢ã«å‚åŠ æ¸ˆã¿ã§ã™ã€‚å…ˆã«å–ã‚Šæ¶ˆã—ã¦ãã ã•ã„ã€‚'); return; }
    }catch(e){ console.error(e); }
    // optimistic UI: notify immediately
    notify('å‚åŠ ã—ã¾ã—ãŸ');
    // fetch current members, append if absent, write back
    try{
      // read current row
      const { data } = await supabase.from('branches').select('members').eq('id', branch.id).maybeSingle();
      let members = (data && data.members) ? data.members.slice() : [];
      if(!members.includes(name)) members.push(name);
      await supabase.from('branches').update({ members }).eq('id', branch.id);
      // supabase realtime will update UI for all clients
    }catch(e){ console.error(e); alert('å‚åŠ å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
  } else {
    const local = readLocal();
    const idx = local.findIndex(x=>x.id===branch.id);
    if(idx>=0 && !local[idx].members.includes(name)){
      local[idx].members.push(name);
      writeLocal(local); renderBranches(local); notify('å‚åŠ ã—ã¾ã—ãŸ');
    }
  }
}

async function handleLeaveClick(branch){
  const name = getName(); if(!name) return ensureName();
  if(useSupabase){
    try{
      // get current members
      const { data } = await supabase.from('branches').select('members').eq('id', branch.id).maybeSingle();
      let members = (data && data.members) ? data.members.slice() : [];
      members = members.filter(m=>m !== name);
      if(members.length === 0){
        // delete branch
        await supabase.from('branches').delete().eq('id', branch.id);
      } else {
        await supabase.from('branches').update({ members }).eq('id', branch.id);
      }
      notify('å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
    }catch(e){ console.error(e); alert('å–ã‚Šæ¶ˆã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
  } else {
    const local = readLocal();
    const idx = local.findIndex(x=>x.id===branch.id);
    if(idx>=0){
      local[idx].members = local[idx].members.filter(m=>m!==name);
      if(local[idx].members.length===0) local.splice(idx,1);
      writeLocal(local); renderBranches(local); notify('å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
    }
  }
}

/* ---------- create branch ---------- */
createBtn.addEventListener('click', async ()=>{
  const name = getName(); if(!name) return ensureName();
  const iso = newDateSel.value; if(!iso){ alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  const date = normalizeDateIsoToYYMMDD(iso);
  const time = newTimeSel.value;
  const place = newPlaceSel.value;

  // double-check iso in options
  const allowed = Array.from(newDateSel.options).map(o=>o.value);
  if(!allowed.includes(iso)){ alert('æœ‰åŠ¹ãªæ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }

  if(useSupabase){
    try{
      notify('ä½œæˆã—ã¾ã—ãŸ');
      await supabase.from('branches').insert([{ date: date, time: time, place: place, title: '', members: [name] }]);
      // realtime updates other clients
    }catch(e){ console.error(e); alert('ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  } else {
    const local = readLocal();
    const b = { id: uid(), date: date, time: time, place: place, title:'', members:[name] };
    local.push(b); writeLocal(local); renderBranches(local); notify('ä½œæˆã—ã¾ã—ãŸ');
  }
});

/* ---------- initial load + realtime subscribe ---------- */
async function bootstrap(){
  if(!useSupabase){
    // local fallback: ensure presets exist once
    let local = readLocal();
    if(local.length===0){
      local = [
        { id: uid(), date:'25/12/29', time:'å¤œ', place:'æ©‹æœ¬', title:'å¤§å­¦å¿˜å¹´ä¼š', members:['Hirao','ãƒˆã‚­ãƒ„','è—¤æœ¨'] },
        { id: uid(), date:'26/01/03', time:'å¤œ', place:'äº¬éƒ½', title:'ä¸­å­¦åŒçª“ä¼š', members:['Ogawa','ã‹ãšã','MOE','Ami','yuina'] }
      ];
      writeLocal(local);
    }
    renderBranches(local);
  } else {
    // fetch and render
    const data = await fetchBranchesSupabase();
    if(!data || data.length===0){
      // insert presets if empty
      try{
        await supabase.from('branches').insert([
          { date:'25/12/29', time:'å¤œ', place:'æ©‹æœ¬', title:'å¤§å­¦å¿˜å¹´ä¼š', members:['Hirao','ãƒˆã‚­ãƒ„','è—¤æœ¨'] },
          { date:'26/01/03', time:'å¤œ', place:'äº¬éƒ½', title:'ä¸­å­¦åŒçª“ä¼š', members:['Ogawa','ã‹ãšã','MOE','Ami','yuina'] }
        ]);
      }catch(e){ console.warn('preset insert issue', e); }
    }
    const fresh = await fetchBranchesSupabase();
    renderBranches(fresh);

    // subscribe realtime
    supabase.channel('public:branches')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'branches' }, payload => {
        (async ()=>{
          const fresh2 = await fetchBranchesSupabase();
          renderBranches(fresh2);
        })();
      }).subscribe().catch(e=>console.warn('subscribe err', e));
  }
}
bootstrap();

</script>
</body>
</html>
