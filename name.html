<script>
function queryParam(name){
  const p = new URLSearchParams(location.search);
  return p.get(name);
}

(async function(){
  const existing = localStorage.getItem('meeting_app_username') || '';
  const editMode = queryParam('edit') === '1';
  const input = document.getElementById('displayName');

  if(existing && !editMode){
    location.replace('index.html');
    return;
  }
  if(existing && editMode){
    input.value = existing;
  }
})();

// new save handler: replace old->new in both Supabase and local fallback
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const newName = (document.getElementById('displayName').value || '').trim().slice(0,20);
  if(!newName){ alert('表示名を入力してください'); return; }

  const oldName = localStorage.getItem('meeting_app_username') || '';

  // save immediately locally
  localStorage.setItem('meeting_app_username', newName);

  // if old exists & different, run replacement
  if(oldName && oldName !== newName){
    // local fallback replace
    try{
      const local = JSON.parse(localStorage.getItem('meeting_app_branches')||'[]');
      let mutated = false;
      const replaced = local.map(b=>{
        if(Array.isArray(b.members)){
          const changed = b.members.map(m => m === oldName ? newName : m);
          if(JSON.stringify(changed) !== JSON.stringify(b.members)){ mutated = true; b.members = changed; }
        }
        return b;
      });
      if(mutated){
        localStorage.setItem('meeting_app_branches', JSON.stringify(replaced));
      }
    }catch(e){ console.warn('local replace err', e); }

    // Supabase replace: fetch all rows, update rows where members include oldName
    if(window.supabase){
      try{
        // fetch only id + members to minimize payload
        const { data, error } = await supabase.from('branches').select('id,members');
        if(error) throw error;
        if(Array.isArray(data)){
          for(const row of data){
            if(Array.isArray(row.members) && row.members.includes(oldName)){
              const newMembers = row.members.map(m => m === oldName ? newName : m);
              await supabase.from('branches').update({ members: newMembers }).eq('id', row.id);
            }
          }
        }
      }catch(e){
        console.error('supabase replace error', e);
        // don't block user — but inform
        alert('表示名の置換（サーバ側）で一部エラーがありました。後で確認してください。');
      }
    }
  }

  // after saving & replacing, go back to index
  location.href = 'index.html';
});
</script>
