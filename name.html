<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>表示名設定</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family:"Inter",sans-serif; background:#f6f6f6; margin:0; }
.wrap { max-width:400px; margin:0 auto; padding:20px; }
.title { font-size:22px; font-weight:600; margin-bottom:20px; }
.card { background:#fff; padding:16px; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,.08); }
button {
  margin-top:12px; width:100%; padding:10px;
  border:none; border-radius:8px; background:#007aff; color:#fff; font-size:15px;
}
label { font-size:14px; }
input {
  margin-top:6px; padding:10px; width:100%; font-size:16px;
  border:1px solid #ccc; border-radius:8px;
}
.notif {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:#333; color:#fff; padding:10px 18px;
  border-radius:8px; opacity:0; pointer-events:none; transition:opacity .4s;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="title">表示名設定</div>

  <div class="card">
    <label>表示名</label>
    <input id="nameInput" placeholder="例：Yuto">
    <button id="saveBtn">保存</button>
  </div>
</div>

<div class="notif" id="notif"></div>

<script>
/* Supabase */
const SUPABASE_URL = "https://agbfcpaxsrgebxjtkvdh.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Notify */
function notify(msg){
  localStorage.setItem("notify_msg", msg);
  location.href = "index.html";
}

/* Init input */
const oldName = localStorage.getItem("username") || "";
document.getElementById("nameInput").value = oldName;

/* Save */
document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const newName = document.getElementById("nameInput").value.trim();
  if(!newName){ alert("名前を入力してください"); return; }

  // ローカル保存
  localStorage.setItem("username", newName);

  // Supabase 全置換
  if(oldName && newName && oldName !== newName){
    const { data, error } = await supabaseClient.from("branches").select("*");
    if(!error && data.length){
      for(const b of data){
        if(b.members.includes(oldName)){
          const newMembers = b.members.map(m=> m===oldName ? newName : m);
          await supabaseClient.from("branches").update({ members:newMembers }).eq("id", b.id);
        }
      }
    }
  }

  notify("表示名を変更しました");
});
</script>
</body>
</html>
